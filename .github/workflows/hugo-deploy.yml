name: Hugo Blog CI/CD

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  schedule:
    # Run twice weekly - Tuesday and Friday at 10:00 AM UTC
    - cron: '0 10 * * 2,5'
  workflow_dispatch: # Allow manual triggering

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: pages
  cancel-in-progress: false

defaults:
  run:
    shell: bash

jobs:
  # Check job for PRs - validates build without deploying
  check:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    env:
      HUGO_VERSION: 0.152.2
      NODE_VERSION: 22.20.0
      TZ: UTC
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Hugo
        run: |
          curl -sLJO "https://github.com/gohugoio/hugo/releases/download/v${HUGO_VERSION}/hugo_extended_${HUGO_VERSION}_linux-amd64.tar.gz"
          mkdir "${HOME}/.local"
          mkdir "${HOME}/.local/hugo"
          tar -C "${HOME}/.local/hugo" -xf "hugo_extended_${HUGO_VERSION}_linux-amd64.tar.gz"
          rm "hugo_extended_${HUGO_VERSION}_linux-amd64.tar.gz"
          echo "${HOME}/.local/hugo" >> "${GITHUB_PATH}"

      - name: Verify Hugo installation
        run: |
          echo "Hugo: $(hugo version)"

      - name: Install Node.js dependencies
        run: |
          [[ -f package-lock.json || -f npm-shrinkwrap.json ]] && npm ci || true

      - name: Check Hugo build
        run: |
          echo "ðŸ” Checking Hugo build..."
          hugo --gc --minify --buildFuture --buildExpired
          echo "âœ… Hugo build check passed!"

      - name: Validate content
        run: |
          echo "ðŸ“ Validating content structure..."
          # Check for required frontmatter in posts
          find content -name "*.md" -not -name "_index.md" | while read file; do
            if ! grep -q "^title:" "$file"; then
              echo "âŒ Missing title in $file"
              exit 1
            fi
            if ! grep -q "^date:" "$file"; then
              echo "âŒ Missing date in $file"  
              exit 1
            fi
          done
          echo "âœ… Content validation passed!"

      - name: Check summary
        run: |
          echo "## PR Check Results âœ…" >> $GITHUB_STEP_SUMMARY
          echo "- Hugo build: âœ… Passed" >> $GITHUB_STEP_SUMMARY
          echo "- Content validation: âœ… Passed" >> $GITHUB_STEP_SUMMARY
          echo "- Ready for merge and deployment" >> $GITHUB_STEP_SUMMARY

  # Build job for production deployment
  build:
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch' || (github.event_name == 'schedule' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'))
    runs-on: ubuntu-latest
    env:
      HUGO_VERSION: 0.152.2
      NODE_VERSION: 22.20.0
      TZ: UTC

    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Setup Pages
        id: pages
        uses: actions/configure-pages@v5

      - name: Install Hugo
        run: |
          curl -sLJO "https://github.com/gohugoio/hugo/releases/download/v${HUGO_VERSION}/hugo_extended_${HUGO_VERSION}_linux-amd64.tar.gz"
          mkdir -p "${HOME}/.local/hugo"
          tar -C "${HOME}/.local/hugo" -xf "hugo_extended_${HUGO_VERSION}_linux-amd64.tar.gz"
          rm "hugo_extended_${HUGO_VERSION}_linux-amd64.tar.gz"
          echo "${HOME}/.local/hugo" >> "${GITHUB_PATH}"

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          echo "ðŸ“¦ Installing Python packages from requirements.txt..."
          
          # Create virtual environment for AI content generation
          python -m venv .venv
          source .venv/bin/activate
          
          pip install -r requirements.txt
          echo "âœ… Python dependencies installed in virtual environment:"
          pip list --format=columns | grep -E "(openai|pyyaml|requests|beautifulsoup4|markdown)" || true

      - name: Setup Ollama
        if: github.event_name == 'schedule' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
        run: |
          echo "ðŸ”§ Installing Ollama..."
          curl -fsSL https://ollama.com/install.sh | sh
          
          echo "ðŸš€ Starting Ollama service..."
          ollama serve &
          
          echo "â³ Waiting for Ollama to be ready..."
          sleep 10
          
          # Check if Ollama is running
          for i in {1..30}; do
            if curl -s http://localhost:11434/api/tags > /dev/null 2>&1; then
              echo "âœ… Ollama is ready!"
              break
            fi
            echo "â³ Waiting for Ollama... ($i/30)"
            sleep 2
          done
          
          echo "ðŸ“¥ Pulling LLaMA 3.2 latest model..."
          ollama pull llama3.2:latest
          
          echo "ðŸ§ª Testing Ollama..."
          ollama list
          
          # Test API endpoint
          curl -X POST http://localhost:11434/v1/chat/completions \
            -H "Content-Type: application/json" \
            -d '{
              "model": "llama3.2:latest",
              "messages": [{"role": "user", "content": "Hello"}],
              "max_tokens": 5
            }' || echo "âš ï¸ Ollama API test failed but continuing..."

      - name: Verify installations
        run: |
          echo "Hugo: $(hugo version)"
          echo "Node.js: $(node --version)"
          echo "Python: $(python --version)"

      - name: Install Node.js dependencies
        run: |
          [[ -f package-lock.json || -f npm-shrinkwrap.json ]] && npm ci || true

      - name: Configure Git
        run: |
          git config core.quotepath false
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

      - name: Generate AI Content
        if: github.event_name == 'schedule' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
        run: |
          echo "ðŸ¤– Generating AI content with simple generator..."
          cd ${{ github.workspace }}
          
          # Check if Ollama is still running
          if ! curl -s http://localhost:11434/api/tags > /dev/null 2>&1; then
            echo "âŒ Ollama is not running, skipping AI content generation"
            exit 0
          fi
          
          # Test the simple AI generator
          echo "ðŸ§ª Testing simple AI content generator..."
          source .venv/bin/activate || python3 -m venv .venv && source .venv/bin/activate
          
          echo "ï¿½ Listing available topics..."
          python scripts/generate.py --model llama3.2:latest --list || echo "âš ï¸ Topic listing failed"
          
          echo "ðŸš€ Generating new content with llama3.2:latest..."
          python scripts/generate.py --model llama3.2:latest --verbose || {
            echo "âš ï¸ AI content generation failed, but continuing with build"
            exit 0
          }
          
          # Check if new content was generated
          if git diff --quiet; then
            echo "â„¹ï¸ No new content generated"
          else
            echo "âœ… New AI content generated"
            git add content/
            git status
          fi

      - name: Cache restore
        id: cache-restore
        uses: actions/cache/restore@v4
        with:
          path: ${{ runner.temp }}/hugo_cache
          key: hugo-${{ github.run_id }}
          restore-keys: hugo-

      - name: Build the site
        run: |
          echo "ðŸ—ï¸ Building Hugo site for deployment..."
          hugo \
            --gc \
            --minify \
            --enableGitInfo \
            --baseURL "${{ steps.pages.outputs.base_url }}/" \
            --cacheDir "${{ runner.temp }}/hugo_cache"

      - name: Cache save
        id: cache-save
        uses: actions/cache/save@v4
        with:
          path: ${{ runner.temp }}/hugo_cache
          key: ${{ steps.cache-restore.outputs.cache-primary-key }}

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./public

      - name: Commit AI-generated content
        if: github.event_name == 'schedule' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
        run: |
          if ! git diff --cached --quiet; then
            echo "ðŸ’¾ Committing AI-generated content..."
            
            # Generate summary of changes for commit message
            NEW_POSTS=$(git diff --cached --name-only | grep -c "\.md$" || echo "0")
            
            COMMIT_MSG="ðŸ¤– AI Content Generation - $(date +'%Y-%m-%d %H:%M UTC')"
            
            git commit -m "$COMMIT_MSG" || echo "Nothing to commit"
            
            echo "ðŸš€ Pushing changes..."
            git push || echo "Push failed, but continuing..."
            
            # Add to job summary
            echo "## ðŸ¤– AI Content Generation Results" >> $GITHUB_STEP_SUMMARY
            echo "- **Model Used**: llama3.2:latest" >> $GITHUB_STEP_SUMMARY
            echo "- **New Posts**: $NEW_POSTS" >> $GITHUB_STEP_SUMMARY
            echo "- **Commit**: Successfully created and pushed" >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸ No changes to commit"
            echo "## ðŸ¤– AI Content Generation Results" >> $GITHUB_STEP_SUMMARY
            echo "- **Model**: llama3.2:latest" >> $GITHUB_STEP_SUMMARY
            echo "- **Status**: No new content generated" >> $GITHUB_STEP_SUMMARY
            echo "- **Reason**: Content already exists or generation skipped" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Build summary
        run: |
          echo "## ðŸš€ Build Complete" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Hugo build successful" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Site ready for deployment" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ github.event_name }}" == "schedule" ]]; then
            echo "- ðŸ¤– Simple AI content generation attempted (llama3.2:latest)" >> $GITHUB_STEP_SUMMARY
          fi
          echo "- ðŸ“¦ Artifact uploaded" >> $GITHUB_STEP_SUMMARY

  # Deploy job
  deploy:
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch' || (github.event_name == 'schedule' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'))
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Deployment summary
        run: |
          echo "## Deployment Results ðŸš€" >> $GITHUB_STEP_SUMMARY
          echo "- Site built successfully: âœ…" >> $GITHUB_STEP_SUMMARY
          echo "- Deployed to GitHub Pages: âœ…" >> $GITHUB_STEP_SUMMARY
          echo "- Live at: ${{ steps.deployment.outputs.page_url }}" >> $GITHUB_STEP_SUMMARY
